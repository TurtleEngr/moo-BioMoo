$Header: /repo/public.cvs/app/BioGate/BioMooCore/core12.moo,v 1.1 2021/07/27 06:44:27 bruce Exp $

>@dump #12 with create
@create $root_class named Guest Log:Guest Log
@prop #12."connections" {} ""
;;#12.("connections") = {{#186, 0, 936908925, "dhcpej0282.mayfield.hp.com"}, {#186, 1, 936908878, "dhcpej0282.mayfield.hp.com"}, {#186, 0, 936903884, "cupm016.cup.hp.com"}, {#186, 1, 936899614, "cupm016.cup.hp.com"}, {#186, 0, 936894381, "dhcpej0282.mayfield.hp.com"}, {#186, 1, 936894361, "dhcpej0282.mayfield.hp.com"}, {#186, 0, 936894263, "mag357.mayfield.hp.com"}, {#186, 1, 936894182, "mag357.mayfield.hp.com"}, {#186, 0, 936894083, "dhcpej0282.mayfield.hp.com"}, {#186, 1, 936893993, "dhcpej0282.mayfield.hp.com"}, {#186, 0, 936320193, "dhcpej0414.mayfield.hp.com"}, {#186, 1, 936317860, "dhcpej0414.mayfield.hp.com"}, {#186, 0, 935797829, "dhcpej0282.mayfield.hp.com"}, {#186, 1, 935797786, "dhcpej0282.mayfield.hp.com"}, {#186, 0, 933897166, "dhcpej0090.mayfield.hp.com"}, {#186, 1, 933897132, "dhcpej0090.mayfield.hp.com"}, {#186, 0, 929481561, "15.123.1.177"}, {#186, 1, 929478020, "15.123.1.177"}, {#186, 0, 929427332, "psonb234.sgp.hp.com"}, {#186, 1, 929427275, "psonb234.sgp.hp.com"}, {#186, 0, 927888712, "athene.gsr.hp.com"}, {#186, 1, 927888690, "athene.gsr.hp.com"}, {#186, 0, 924217655, "hpledk3.hpl.hp.com"}, {#186, 1, 924215849, "hpledk3.hpl.hp.com"}, {#186, 0, 924215845, "hpledk3.hpl.hp.com"}, {#186, 1, 924215325, "hpledk3.hpl.hp.com"}, {#186, 0, 922205741, "athene.gsr.hp.com"}, {#186, 1, 922205511, "athene.gsr.hp.com"}, {#186, 0, 921695282, "e2603emt.msr.hp.com"}, {#186, 1, 921694234, "e2603emt.msr.hp.com"}, {#186, 0, 920070399, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 920069699, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 916273271, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 916270924, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 915623598, "pshbkim.korea.hp.com"}, {#186, 1, 915623473, "pshbkim.korea.hp.com"}, {#186, 0, 913076756, "psbckim.korea.hp.com"}, {#186, 1, 913076679, "psbckim.korea.hp.com"}, {#186, 0, 911320261, "dhcpik-130.mayfield.hp.com"}, {#186, 1, 911319899, "dhcpik-130.mayfield.hp.com"}, {#186, 0, 911319896, "dhcpik-130.mayfield.hp.com"}, {#186, 1, 911318908, "dhcpik-130.mayfield.hp.com"}, {#186, 0, 910898926, "dhcpik-139.mayfield.hp.com"}, {#186, 1, 910898895, "dhcpik-139.mayfield.hp.com"}, {#186, 0, 910898892, "dhcpik-139.mayfield.hp.com"}, {#186, 1, 910898430, "dhcpik-139.mayfield.hp.com"}, {#186, 0, 910821612, "atlm0340.atl.hp.com"}, {#186, 1, 910803234, "atlm0340.atl.hp.com"}, {#186, 0, 910803187, "atlm0340.atl.hp.com"}, {#186, 1, 910803091, "atlm0340.atl.hp.com"}, {#186, 0, 910656264, "dhcpij-5.mayfield.hp.com"}, {#186, 1, 910656086, "dhcpij-5.mayfield.hp.com"}, {#186, 0, 910655954, "dhcpij-5.mayfield.hp.com"}, {#186, 1, 910655893, "dhcpij-5.mayfield.hp.com"}, {#186, 0, 910655794, "dhcpij-5.mayfield.hp.com"}, {#186, 1, 910655735, "dhcpij-5.mayfield.hp.com"}, {#186, 0, 910636148, "dhcpij-5.mayfield.hp.com"}, {#186, 1, 910634490, "dhcpij-5.mayfield.hp.com"}, {#399, 0, 910634427, "dhcpij-5.mayfield.hp.com"}, {#186, 0, 910634427, "dhcpij-5.mayfield.hp.com"}, {#399, 1, 910634400, "dhcpij-5.mayfield.hp.com"}, {#401, 0, 910634390, "dhcpij-5.mayfield.hp.com"}, {#401, 1, 910634326, "dhcpij-5.mayfield.hp.com"}, {#186, 1, 910634101, "dhcpij-5.mayfield.hp.com"}, {#399, 0, 910633697, "fdgroot.neth.hp.com"}, {#186, 0, 910633689, "fdgroot.neth.hp.com"}, {#399, 1, 910633471, "fdgroot.neth.hp.com"}, {#186, 1, 910632582, "fdgroot.neth.hp.com"}, {#186, 0, 908454454, "jorisb.belgium.hp.com"}, {#186, 1, 908454102, "jorisb.belgium.hp.com"}, {#186, 0, 907770764, "tcnielson2603.msr.hp.com"}, {#186, 1, 907766182, "tcnielson2603.msr.hp.com"}, {#186, 0, 906486348, "15.35.78.56"}, {#186, 1, 906486187, "15.35.78.56"}, {#186, 0, 906056863, "custeda.mayfield.hp.com"}, {#186, 1, 906056850, "custeda.mayfield.hp.com"}, {#186, 0, 906056482, "custeda.mayfield.hp.com"}, {#186, 1, 906056328, "custeda.mayfield.hp.com"}, {#186, 0, 905884165, "custeda.mayfield.hp.com"}, {#186, 1, 905883323, "custeda.mayfield.hp.com"}, {#186, 0, 904540867, "psbckim.korea.hp.com"}, {#186, 1, 904540411, "psbckim.korea.hp.com"}, {#186, 0, 903485511, "custeda.mayfield.hp.com"}, {#186, 1, 903473813, "custeda.mayfield.hp.com"}, {#186, 0, 903466693, "custeda.mayfield.hp.com"}, {#186, 1, 903464477, "custeda.mayfield.hp.com"}, {#186, 0, 902524636, "hppsd-i0004.mayfield.hp.com"}, {#186, 1, 902523254, "hppsd-i0004.mayfield.hp.com"}, {#186, 0, 902471819, "sant0198.safrica.hp.com"}, {#186, 1, 902471657, "sant0198.safrica.hp.com"}, {#186, 0, 902186418, "dhcpij-134.mayfield.hp.com"}, {#186, 1, 902186249, "dhcpij-134.mayfield.hp.com"}, {#186, 0, 901044432, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 901044236, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 900800535, "egipto.arg.hp.com"}, {#400, 0, 900798709, "egipto.arg.hp.com"}, {#186, 1, 900798010, "egipto.arg.hp.com"}, {#403, 0, 900720868, "egipto.arg.hp.com"}, {#186, 0, 900720267, "egipto.arg.hp.com"}, {#403, 1, 900720267, "egipto.arg.hp.com"}, {#186, 1, 900706560, "egipto.arg.hp.com"}, {#186, 0, 900645006, "egipto.arg.hp.com"}, {#400, 1, 900643987, "egipto.arg.hp.com"}, {#186, 1, 900642585, "egipto.arg.hp.com"}, {#186, 0, 898253415, "jcoe3300.jpn.hp.com"}, {#186, 1, 898253284, "jcoe3300.jpn.hp.com"}, {#186, 0, 898253281, "jcoe3300.jpn.hp.com"}, {#186, 1, 898253096, "jcoe3300.jpn.hp.com"}, {#186, 0, 897609436, "purple.mayfield.hp.com"}, {#397, 0, 897609422, "purple.mayfield.hp.com"}, {#397, 1, 897609357, "purple.mayfield.hp.com"}, {#186, 1, 897608710, "purple.mayfield.hp.com"}, {#397, 0, 897608371, "purple.mayfield.hp.com"}, {#186, 0, 897608371, "purple.mayfield.hp.com"}, {#397, 1, 897602197, "purple.mayfield.hp.com"}, {#186, 1, 897600978, "purple.mayfield.hp.com"}, {#186, 0, 897501227, "fcpss3203.fc.hp.com"}, {#186, 1, 897484601, "fcpss3203.fc.hp.com"}, {#186, 0, 896981644, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 896981590, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 896833947, "custeda.mayfield.hp.com"}, {#186, 1, 896831568, "custeda.mayfield.hp.com"}, {#186, 0, 896831458, "custeda.mayfield.hp.com"}, {#186, 1, 896808383, "custeda.mayfield.hp.com"}, {#186, 0, 896479868, "hppsd-i1178.mayfield.hp.com"}, {#186, 1, 896476822, "hppsd-i1178.mayfield.hp.com"}, {#186, 0, 895875767, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 895875668, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 895874347, "hpsdce.mayfield.hp.com"}, {#186, 1, 895873934, "hpsdce.mayfield.hp.com"}, {#186, 0, 895266197, "custeda.mayfield.hp.com"}, {#186, 1, 895266196, "custeda.mayfield.hp.com"}, {#186, 0, 895072383, "dhcpij-134.mayfield.hp.com"}, {#186, 1, 895072317, "dhcpij-134.mayfield.hp.com"}, {#186, 0, 894981367, "15.164.4.90"}, {#186, 1, 894981109, "15.164.4.90"}, {#186, 0, 894913248, "custeda.mayfield.hp.com"}, {#186, 1, 894913238, "custeda.mayfield.hp.com"}, {#186, 0, 894896342, "pmooney-ntp.mayfield.hp.com"}, {#186, 1, 894895784, "pmooney-ntp.mayfield.hp.com"}, {#186, 0, 894588665, "wkaster-ntp.mayfield.hp.com"}, {#399, 0, 894570276, "dhcpij-150.mayfield.hp.com"}, {#186, 1, 894565251, "wkaster-ntp.mayfield.hp.com"}, {#186, 0, 894563468, "dhcpij-68.mayfield.hp.com"}, {#399, 1, 894563271, "dhcpij-150.mayfield.hp.com"}, {#398, 0, 894563260, "dhcpij-150.mayfield.hp.com"}, {#398, 1, 894562896, "dhcpij-150.mayfield.hp.com"}, {#186, 1, 894562824, "dhcpij-68.mayfield.hp.com"}, {#186, 0, 894562516, "dhcpij-134.mayfield.hp.com"}, {#186, 1, 894562420, "dhcpij-134.mayfield.hp.com"}, {#186, 0, 894561121, "15.3.40.226"}, {#186, 1, 894560910, "15.3.40.226"}, {#186, 0, 894481266, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 894479999, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 894329220, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 894329031, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 894329006, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 894328989, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 893971399, "dhcpij-134.mayfield.hp.com"}, {#186, 1, 893971007, "dhcpij-134.mayfield.hp.com"}, {#186, 0, 893787071, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 893785700, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 893725575, "rafnelb-ntp.mayfield.hp.com"}, {#186, 1, 893725152, "rafnelb-ntp.mayfield.hp.com"}, {#186, 0, 893383263, "custeda.mayfield.hp.com"}, {#403, 0, 893279062, "custeda.mayfield.hp.com"}, {#403, 1, 893279050, "custeda.mayfield.hp.com"}, {#186, 1, 893267586, "custeda.mayfield.hp.com"}, {#186, 0, 893124517, "dhcpij-113.mayfield.hp.com"}, {#186, 1, 893114574, "dhcpij-113.mayfield.hp.com"}, {#186, 0, 893113356, "l3107wes.atl.hp.com"}, {#186, 1, 893102884, "l3107wes.atl.hp.com"}, {#186, 0, 892684155, "hpfcma.fc.hp.com"}, {#186, 1, 892684106, "hpfcma.fc.hp.com"}, {#186, 0, 892586017, "ledesma-gerard.corp.hp.com"}, {#186, 1, 892572316, "ledesma-gerard.corp.hp.com"}, {#186, 0, 892171582, "psonew.mayfield.hp.com"}, {#186, 1, 892159988, "psonew.mayfield.hp.com"}, {#186, 0, 891995289, "psonew.mayfield.hp.com"}, {#186, 1, 891995274, "psonew.mayfield.hp.com"}, {#186, 0, 891969348, "purple.mayfield.hp.com"}, {#397, 0, 891288787, "dhcpij-0.mayfield.hp.com"}, {#397, 1, 891288678, "dhcpij-0.mayfield.hp.com"}, {#399, 0, 890919060, "l3107wes.atl.hp.com"}, {#399, 1, 890918491, "l3107wes.atl.hp.com"}, {#186, 1, 890903721, "purple.mayfield.hp.com"}, {#186, 0, 890903719, "purple.mayfield.hp.com"}, {#186, 1, 890903442, "purple.mayfield.hp.com"}, {#186, 0, 890903440, "purple.mayfield.hp.com"}, {#186, 1, 890869785, "purple.mayfield.hp.com"}, {#186, 0, 890869783, "purple.mayfield.hp.com"}, {#186, 1, 890869619, "purple.mayfield.hp.com"}, {#397, 0, 890759020, "purple.mayfield.hp.com"}, {#186, 0, 890759020, "purple.mayfield.hp.com"}, {#399, 0, 890759019, "purple.mayfield.hp.com"}, {#402, 0, 890759019, "purple.mayfield.hp.com"}, {#401, 0, 890759018, "purple.mayfield.hp.com"}, {#401, 1, 890716827, "purple.mayfield.hp.com"}, {#402, 1, 890716712, "purple.mayfield.hp.com"}, {#399, 1, 890712387, "purple.mayfield.hp.com"}}
@prop #12."max_entries" 199 ""
;;#12.("aliases") = {"Guest Log"}
;;#12.("object_size") = {15009, 1577149623}

@verb #12:"enter" this none this
@program #12:enter
":enter(who,islogin,time,site)";
"adds an entry to the connection log for a given guest (caller).";
if ($object_utils:isa(caller, $guest))
  $guest_log.connections = {{caller, @args}, @$guest_log.connections[1..min($guest_log.max_entries, $)]};
else
  return E_PERM;
endif
.

@verb #12:"last" this none this
@program #12:last
":last([n,[guest_list]])";
"print list of the last n entries in the guest log";
" (use n=0 if you want all entries)";
" optional second arg limits listing to the specified guest(s)";
set_task_perms(caller_perms());
{?howmany = 0, ?which = 0} = args;
howmany = min(howmany || $maxint, length($guest_log.connections));
if (!caller_perms().wizard)
  player:notify("Sorry.");
else
  current = {};
  listing = {};
  last = 0;
  for c in ($guest_log.connections[1..howmany])
    if (which && (!(c[1] in which)))
    elseif (c[2])
      "...login...";
      if (a = $list_utils:assoc(c[1], current))
        listing[a[2]][3] = c[3];
        current = setremove(current, a);
      else
        listing = {@listing, {c[1], c[4], c[3], $object_utils:connected(c[1]) ? -idle_seconds(c[1]) | 1}};
        last = last + 1;
      endif
    else
      "...logout...";
      listing = {@listing, {c[1], c[4], 0, c[3]}};
      last = last + 1;
      if (i = $list_utils:iassoc(c[1], current))
        current[i][2] = last;
      else
        current = {@current, {c[1], last}};
      endif
    endif
    $command_utils:suspend_if_needed(2);
  endfor
  su = $string_utils;
  player:notify(su:left(su:left(su:left("Guest", 20) + "Connected", 36) + "Idle/Disconn.", 52) + "From");
  player:notify(su:left(su:left(su:left("-----", 20) + "---------", 36) + "-------------", 52) + "----");
  for l in (listing)
    on = l[3] ? (ct = ctime(l[3]))[1..3] + ct[9..19] | "earlier";
    off = (l[4] > 0) ? (ct = ctime(l[4]))[1..3] + ct[9..19] | ("  " + $string_utils:from_seconds(-l[4]));
    player:notify(su:left(su:left(su:right(tostr(strsub(l[1].name, "uest", "."), " (", l[1], ")  "), -20) + on, 36) + off, 52) + l[2]);
    $command_utils:suspend_if_needed(2);
  endfor
endif
.

@verb #12:"init_for_core" this none this
@program #12:init_for_core
if (caller_perms().wizard)
  pass(@args);
  this.connections = {};
endif
.

@verb #12:"find" this none this
@program #12:find
":find(guest_id,time)";
" => site name of guest logged in at that time";
" => 0 if not logged in";
" => E_NACC if this is earlier than the earliest guest recorded";
set_task_perms(caller_perms());
{who, when} = args;
if (!caller_perms().wizard)
  raise(E_PERM);
else
  found = (who in connected_players()) ? $string_utils:connection_hostname(who.last_connect_place) | 0;
  for c in ($guest_log.connections)
    if (c[3] < when)
      return found;
    elseif (c[1] != who)
      "... different guest...";
    elseif (c[2])
      "...login...";
      if (c[3] == when)
        return found;
      endif
      found = 0;
    else
      "...logout...";
      found = c[4];
    endif
  endfor
  return E_NACC;
endif
.

"***finished***
